# æ•°æ®å¯¼å…¥é—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

### 1. ç¼–ç é”™è¯¯ï¼š'gbk' codec can't decode byte 0x80

**åŸå› **ï¼š
- Windowsç³»ç»Ÿé»˜è®¤ä½¿ç”¨GBKç¼–ç è¯»å–æ–‡ä»¶
- ä½†CSVæ•°æ®æ–‡ä»¶å¯èƒ½æ˜¯UTF-8ã€GBKæˆ–å…¶ä»–ç¼–ç 
- ç¡¬ç¼–ç ä½¿ç”¨`encoding='utf-8-sig'`ä¼šå¯¼è‡´GBKæ–‡ä»¶è¯»å–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `chardet` åº“è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç 
- å®ç°ä¸‰å±‚ç¼–ç å®¹é”™æœºåˆ¶ï¼š
  1. é¦–å…ˆä½¿ç”¨æ£€æµ‹åˆ°çš„ç¼–ç 
  2. å¦‚æœå¤±è´¥ï¼Œå°è¯• UTF-8-sig
  3. å¦‚æœä»å¤±è´¥ï¼Œå°è¯• GBK

### 2. è·¯å¾„é—®é¢˜ï¼šè¯´æ˜çš„è·¯å¾„ä¸å®é™…ä¸åŒ

**åŸå› **ï¼š
- æ—§ä»£ç ç¡¬ç¼–ç æ–‡ä»¶åï¼ˆå¦‚`semrush_processed.csv`ï¼‰
- å®é™…æ–‡ä»¶åå¯èƒ½ä¸åŒ
- ç¼ºå°‘å¿…è¦çš„æ•°æ®ç›®å½•ç»“æ„

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°è‡ªåŠ¨æ–‡ä»¶å‘ç°åŠŸèƒ½ `_discover_data_files()`
- æ”¯æŒå­ç›®å½•ç»“æ„ï¼ˆæ¨èï¼‰ï¼š
  - `data/raw/semrush/` - ä»»æ„.csvæ–‡ä»¶
  - `data/raw/dropdown/` - ä»»æ„.csvæ–‡ä»¶
  - `data/raw/related_search/` - ä»»æ„.csv/.xlsxæ–‡ä»¶
- æ”¯æŒç›´æ¥æ”¾ç½®ï¼ˆå¤‡é€‰ï¼‰ï¼š
  - `data/raw/*semrush*.csv`
  - `data/raw/*dropdown*.csv`
  - `data/raw/*related*.csv`

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. core/data_integration.py

**ä¸»è¦ä¿®æ”¹**ï¼š

```python
# æ·»åŠ ç¼–ç æ£€æµ‹åŠŸèƒ½
import chardet

def detect_file_encoding(file_path: Path) -> str:
    """è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç """
    with open(file_path, 'rb') as f:
        raw_data = f.read(10000)
        result = chardet.detect(raw_data)
        encoding = result['encoding']
        # å¤„ç†å¸¸è§ç¼–ç æ˜ å°„
        if encoding and encoding.lower() in ['gb2312', 'gbk', 'gb18030']:
            return 'gbk'
        elif encoding and 'utf' in encoding.lower():
            return 'utf-8-sig'
        else:
            return encoding or 'utf-8-sig'

# æ·»åŠ æ–‡ä»¶è‡ªåŠ¨å‘ç°
def _discover_data_files(self) -> Dict[str, Path]:
    """è‡ªåŠ¨å‘ç°åŸå§‹æ•°æ®æ–‡ä»¶"""
    discovered = {}

    # åœ¨å­ç›®å½•ä¸­æŸ¥æ‰¾
    for source in ['semrush', 'dropdown', 'related_search']:
        source_dir = self.raw_data_dir / source
        if source_dir.exists():
            csv_files = list(source_dir.glob('*.csv'))
            if source == 'related_search':
                xlsx_files = list(source_dir.glob('*.xlsx'))
                if xlsx_files:
                    discovered[source] = xlsx_files[0]
            if csv_files:
                discovered[source] = csv_files[0]

    # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨rawç›®å½•ç›´æ¥æŸ¥æ‰¾
    if not discovered:
        patterns = {
            'semrush': '*semrush*.csv',
            'dropdown': '*dropdown*.csv',
            'related_search': '*related*.csv'
        }
        for source, pattern in patterns.items():
            files = list(self.raw_data_dir.glob(pattern))
            if files:
                discovered[source] = files[0]

    return discovered

# ä¿®æ”¹åŠ è½½å‡½æ•°å¢åŠ å®¹é”™
def load_semrush_data(self) -> pd.DataFrame:
    if 'semrush' not in self.source_files:
        logger.warning("SEMRUSHæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡")
        return pd.DataFrame()

    file_path = self.source_files['semrush']

    # è‡ªåŠ¨æ£€æµ‹ç¼–ç 
    encoding = detect_file_encoding(file_path)
    logger.info(f"   æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç : {encoding}")

    # ä¸‰å±‚å®¹é”™
    try:
        df = pd.read_csv(file_path, encoding=encoding)
    except Exception as e:
        logger.warning(f"   ä½¿ç”¨ {encoding} ç¼–ç å¤±è´¥ï¼Œå°è¯• utf-8-sig...")
        try:
            df = pd.read_csv(file_path, encoding='utf-8-sig')
        except:
            logger.warning(f"   ä½¿ç”¨ utf-8-sig å¤±è´¥ï¼Œå°è¯• gbk...")
            df = pd.read_csv(file_path, encoding='gbk')
```

### 2. requirements.txt

**æ·»åŠ ä¾èµ–**ï¼š
```
# ç¼–ç æ£€æµ‹
chardet>=3.0.4
```

### 3. åˆ›å»ºçš„æ–°æ–‡ä»¶

- `data/raw/README.md` - æ•°æ®ç›®å½•ä½¿ç”¨è¯´æ˜
- `data/raw/semrush/example_data.csv` - ç¤ºä¾‹æ•°æ®æ–‡ä»¶
- åˆ›å»ºç›®å½•ç»“æ„ï¼š
  - `data/raw/semrush/`
  - `data/raw/dropdown/`
  - `data/raw/related_search/`
  - `data/processed/`

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

1. **å‡†å¤‡æ•°æ®æ–‡ä»¶**ï¼ˆä¸‰é€‰ä¸€ï¼‰ï¼š

   **æ–¹æ³•Aï¼šä½¿ç”¨å­ç›®å½•ï¼ˆæ¨èï¼‰**
   ```
   data/raw/semrush/ä½ çš„æ–‡ä»¶.csv
   data/raw/dropdown/ä½ çš„æ–‡ä»¶.csv
   data/raw/related_search/ä½ çš„æ–‡ä»¶.csv
   ```

   **æ–¹æ³•Bï¼šç›´æ¥æ”¾åœ¨rawç›®å½•**
   ```
   data/raw/semrush_data.csv
   data/raw/dropdown_data.csv
   ```

   **æ–¹æ³•Cï¼šä½¿ç”¨ç¤ºä¾‹æ•°æ®**
   ```
   å·²åˆ›å»ºç¤ºä¾‹æ–‡ä»¶ï¼šdata/raw/semrush/example_data.csv
   ç›´æ¥è¿è¡Œå³å¯æµ‹è¯•
   ```

2. **æ•°æ®æ–‡ä»¶æ ¼å¼**ï¼š

   CSVæ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼š
   - `phrase` - çŸ­è¯­/å…³é”®è¯ï¼ˆå¿…éœ€ï¼‰
   - `seed_word` - ç§å­è¯/è¯æ ¹ï¼ˆå¿…éœ€ï¼‰
   - `frequency` - é¢‘æ¬¡ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
   - `volume` - æœç´¢é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰

   ç¤ºä¾‹ï¼š
   ```csv
   phrase,seed_word,frequency,volume
   best calculator app,calculator,25,12000
   free calculator online,calculator,20,8500
   scientific calculator,calculator,18,9200
   ```

3. **è¿è¡Œå¯¼å…¥**ï¼š

   **è¯•è¿è¡Œï¼ˆæ¨èå…ˆæµ‹è¯•ï¼‰**ï¼š
   ```bash
   python scripts/run_phase1_import.py --dry-run
   ```

   **æ­£å¼å¯¼å…¥**ï¼š
   ```bash
   python scripts/run_phase1_import.py
   ```

   **æŒ‡å®šè½®æ¬¡**ï¼š
   ```bash
   python scripts/run_phase1_import.py --round-id 2
   ```

## éªŒè¯ç»“æœ

### æˆåŠŸæ ‡å¿—

è¿è¡Œååº”çœ‹åˆ°ï¼š
```
ã€æ­¥éª¤3ã€‘æ•°æ®æ•´åˆä¸æ¸…æ´—...
åŠ è½½SEMRUSHæ•°æ®: example_data.csv
   æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç : ascii (æˆ– utf-8-sig, gbk)
æˆåŠŸåŠ è½½ 15 æ¡SEMRUSHè®°å½•

ğŸ“Š æ•°æ®ç»Ÿè®¡
æ€»è®°å½•æ•°: 15
æŒ‰æ•°æ®æºåˆ†å¸ƒ:
  semrush    15

âœ… Phase 1 æ•°æ®å¯¼å…¥å®Œæˆï¼
```

### æ£€æŸ¥è¾“å‡ºæ–‡ä»¶

å¯¼å…¥æˆåŠŸåä¼šç”Ÿæˆï¼š
- `data/processed/integrated_round1.csv` - æ¸…æ´—åçš„æ•°æ®
- æ•°æ®åº“ `phrases` è¡¨ä¸­æ–°å¢è®°å½•

## å¸¸è§é—®é¢˜

### Q1: ç¼–ç è­¦å‘Šä½†åŠŸèƒ½æ­£å¸¸

**ç°è±¡**ï¼š
```
--- Logging error ---
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f4ca'
```

**è¯´æ˜**ï¼š
- è¿™æ˜¯loggerè¾“å‡ºemojiç¬¦å·çš„ç¼–ç é—®é¢˜
- **ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½**
- æ•°æ®å¯¼å…¥ä»ç„¶æ­£å¸¸å®Œæˆ
- å¯ä»¥å¿½ç•¥è¿™äº›è­¦å‘Š

### Q2: æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶

**é”™è¯¯**ï¼š
```
ä¸‹æ‹‰è¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
ç›¸å…³æœç´¢æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
```

**è§£å†³**ï¼š
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œç¨‹åºä¼šè·³è¿‡ä¸å­˜åœ¨çš„æ•°æ®æº
- è‡³å°‘éœ€è¦ä¸€ä¸ªæ•°æ®æºï¼ˆsemrush/dropdown/related_searchï¼‰
- å¯ä»¥ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•

### Q3: åˆ—åä¸åŒ¹é…

**é”™è¯¯**ï¼š
```
KeyError: 'phrase'
```

**è§£å†³**ï¼š
1. æ£€æŸ¥CSVç¬¬ä¸€è¡Œï¼ˆåˆ—åï¼‰
2. ç¡®ä¿åŒ…å« `phrase` å’Œ `seed_word` åˆ—
3. åˆ—åä¸åŒºåˆ†å¤§å°å†™

### Q4: Excelæ–‡ä»¶ä¹±ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨Excelä¸­æ‰“å¼€æ–‡ä»¶
2. "æ–‡ä»¶" â†’ "å¦å­˜ä¸º"
3. é€‰æ‹©æ ¼å¼ï¼š**"CSV UTF-8ï¼ˆé€—å·åˆ†éš”ï¼‰(*.csv)"**
4. ä¿å­˜åé‡æ–°å¯¼å…¥

## ä¸‹ä¸€æ­¥

æ•°æ®å¯¼å…¥æˆåŠŸåï¼Œç»§ç»­ï¼š

1. **æŸ¥çœ‹æ¸…æ´—åçš„æ•°æ®**ï¼š
   ```bash
   # Windows PowerShell
   type data\processed\integrated_round1.csv

   # æˆ–ç”¨Excelæ‰“å¼€
   start data\processed\integrated_round1.csv
   ```

2. **è¿è¡Œ Phase 2 èšç±»**ï¼š
   ```bash
   python scripts/run_phase2_clustering.py
   ```

3. **ä½¿ç”¨Web UI**ï¼š
   ```bash
   streamlit run web_ui.py
   # è®¿é—® http://localhost:8501
   ```

## æŠ€æœ¯ç»†èŠ‚

### ç¼–ç æ£€æµ‹åŸç†

ä½¿ç”¨ `chardet` åº“åˆ†ææ–‡ä»¶å‰10000å­—èŠ‚ï¼š
- æ£€æµ‹æ¦‚ç‡æœ€é«˜çš„ç¼–ç 
- æ˜ å°„åˆ°å¸¸ç”¨ç¼–ç ï¼ˆGBKã€UTF-8ï¼‰
- ä¸‰å±‚å®¹é”™ç¡®ä¿æˆåŠŸç‡

### æ–‡ä»¶å‘ç°ä¼˜å…ˆçº§

1. å­ç›®å½•ä¼˜å…ˆï¼š`data/raw/semrush/*.csv`
2. æ¨¡ç³ŠåŒ¹é…å¤‡é€‰ï¼š`data/raw/*semrush*.csv`
3. å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ–‡ä»¶

### æ•°æ®æ¸…æ´—è§„åˆ™

- è½¬å°å†™
- å»é™¤å¤šä½™ç©ºæ ¼
- é•¿åº¦é™åˆ¶ï¼š1-255å­—ç¬¦
- è¿‡æ»¤çº¯æ•°å­—
- è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦è¿‡å¤šçš„çŸ­è¯­ï¼ˆ<50%æœ‰æ•ˆå­—ç¬¦ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-12-26
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡ï¼ˆä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼‰
**å½±å“èŒƒå›´**ï¼šPhase 1 æ•°æ®å¯¼å…¥æ¨¡å—
