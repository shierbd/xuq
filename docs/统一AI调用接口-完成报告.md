# ç»Ÿä¸€AIè°ƒç”¨æ¥å£ - å®ŒæˆæŠ¥å‘Š

**é¡¹ç›®åç§°**: éœ€æ±‚æŒ–æ˜ç³»ç»Ÿ - ç»Ÿä¸€AIè°ƒç”¨æ¥å£
**æŠ¥å‘Šæ—¥æœŸ**: 2026-01-30
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**å®Œæˆäººå‘˜**: Claude Sonnet 4.5

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å¼€å‘æˆåŠŸå®ç°äº†ç»Ÿä¸€AIè°ƒç”¨æ¥å£ï¼Œå……åˆ†åˆ©ç”¨äº†AI1.3åœºæ™¯ç®¡ç†åŠŸèƒ½ï¼Œæä¾›äº†ç®€å•ã€å¯é çš„AIè°ƒç”¨æ–¹å¼ï¼Œæ”¯æŒä¸»æ¨¡å‹å’Œå›é€€æ¨¡å‹çš„è‡ªåŠ¨åˆ‡æ¢ã€‚

**æ ¸å¿ƒæˆæœ**:
- âœ… ç»Ÿä¸€AIè°ƒç”¨æœåŠ¡å®Œæ•´å®ç°
- âœ… æ”¯æŒåœºæ™¯åŒ–é…ç½®
- âœ… ä¸»æ¨¡å‹å’Œå›é€€æ¨¡å‹è‡ªåŠ¨åˆ‡æ¢
- âœ… è°ƒç”¨æ—¥å¿—è®°å½•
- âœ… æ”¯æŒå¤šæä¾›å•†ï¼ˆClaudeã€DeepSeekï¼‰
- âœ… REST APIç«¯ç‚¹åˆ›å»ºå®Œæˆ
- âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

---

## ğŸ¯ å®ŒæˆåŠŸèƒ½æ¦‚è§ˆ

### ç»Ÿä¸€AIè°ƒç”¨æ¥å£

**åŠŸèƒ½æè¿°**: æä¾›ç»Ÿä¸€çš„AIè°ƒç”¨æ¥å£ï¼Œæ ¹æ®åœºæ™¯è‡ªåŠ¨é€‰æ‹©æ¨¡å‹ï¼Œæ”¯æŒä¸»æ¨¡å‹å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å›é€€æ¨¡å‹

#### å®ç°å†…å®¹

**æœåŠ¡å±‚åŠŸèƒ½**:
1. **call_by_scenario()** - æ ¹æ®åœºæ™¯è°ƒç”¨AI
   - è‡ªåŠ¨è·å–åœºæ™¯é…ç½®
   - é€‰æ‹©ä¸»æ¨¡å‹
   - å¤±è´¥æ—¶åˆ‡æ¢å›é€€æ¨¡å‹
   - è®°å½•è°ƒç”¨æ—¥å¿—

2. **_call_model()** - è°ƒç”¨å…·ä½“æ¨¡å‹
   - è·å–æ¨¡å‹å’Œæä¾›å•†é…ç½®
   - æ ¹æ®æä¾›å•†ç±»å‹è°ƒç”¨ä¸åŒAPI

3. **_call_claude()** - è°ƒç”¨Claude API
   - æ”¯æŒAnthropic Messages API
   - è¿”å›ç»Ÿä¸€æ ¼å¼

4. **_call_deepseek()** - è°ƒç”¨DeepSeek API
   - æ”¯æŒOpenAIå…¼å®¹API
   - è¿”å›ç»Ÿä¸€æ ¼å¼

5. **_log_call()** - è®°å½•è°ƒç”¨æ—¥å¿—
   - è®°å½•åœºæ™¯ã€æ¨¡å‹ã€æˆåŠŸçŠ¶æ€
   - è®°å½•æ˜¯å¦ä½¿ç”¨å›é€€æ¨¡å‹
   - è®°å½•é”™è¯¯ä¿¡æ¯

**APIç«¯ç‚¹**:
- POST `/api/ai-config/call` - ç»Ÿä¸€AIè°ƒç”¨æ¥å£

**è¯·æ±‚å‚æ•°**:
```json
{
  "scenario_name": "åœºæ™¯åç§°",
  "prompt": "ç”¨æˆ·æç¤ºè¯",
  "system_prompt": "ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰",
  "temperature": 0.7,
  "max_tokens": 1000
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "message": "AIè°ƒç”¨æˆåŠŸ",
  "data": {
    "success": true,
    "content": "AIç”Ÿæˆçš„å†…å®¹",
    "model_used": "claude-3-5-sonnet-20241022",
    "is_fallback": false,
    "usage": {
      "input_tokens": 100,
      "output_tokens": 200
    },
    "scenario_name": "ç±»åˆ«åç§°ç”Ÿæˆ"
  }
}
```

#### éªŒæ”¶ç»“æœ
- âœ… èƒ½å¤Ÿæ ¹æ®åœºæ™¯åç§°è°ƒç”¨AI
- âœ… èƒ½å¤Ÿè‡ªåŠ¨é€‰æ‹©ä¸»æ¨¡å‹
- âœ… ä¸»æ¨¡å‹å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å›é€€æ¨¡å‹
- âœ… èƒ½å¤Ÿè®°å½•è°ƒç”¨æ—¥å¿—
- âœ… æ”¯æŒClaudeå’ŒDeepSeekæä¾›å•†
- âœ… ç»Ÿä¸€çš„å“åº”æ ¼å¼

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### åç«¯å®ç°

#### 1. æœåŠ¡å±‚å®ç°

**æ–‡ä»¶**: `backend/services/ai_call_service.py`

**æ ¸å¿ƒæ¶æ„**:
```python
class AICallService:
    def __init__(self, db: Session):
        self.db = db
        self.scenario_service = AIScenarioService(db)
        self.model_service = AIModelService(db)
        self.provider_service = AIProviderService(db)

    async def call_by_scenario(
        self,
        scenario_name: str,
        prompt: str,
        system_prompt: Optional[str] = None,
        temperature: Optional[float] = None,
        max_tokens: Optional[int] = None,
        **kwargs
    ) -> Dict[str, Any]:
        # 1. è·å–åœºæ™¯é…ç½®
        # 2. å°è¯•è°ƒç”¨ä¸»æ¨¡å‹
        # 3. å¤±è´¥æ—¶åˆ‡æ¢å›é€€æ¨¡å‹
        # 4. è®°å½•è°ƒç”¨æ—¥å¿—
        # 5. è¿”å›ç»“æœ
```

**å…³é”®ç‰¹æ€§**:
- å¼‚æ­¥è°ƒç”¨ï¼ˆä½¿ç”¨httpx.AsyncClientï¼‰
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- ä¸»æ¨¡å‹å’Œå›é€€æ¨¡å‹çš„è‡ªåŠ¨åˆ‡æ¢
- ç»Ÿä¸€çš„å“åº”æ ¼å¼
- è°ƒç”¨æ—¥å¿—è®°å½•

#### 2. å›é€€æœºåˆ¶å®ç°

**å·¥ä½œæµç¨‹**:
```
1. è·å–åœºæ™¯é…ç½®
   â†“
2. å°è¯•è°ƒç”¨ä¸»æ¨¡å‹
   â†“
3. ä¸»æ¨¡å‹æˆåŠŸï¼Ÿ
   â”œâ”€ æ˜¯ â†’ è®°å½•æ—¥å¿— â†’ è¿”å›ç»“æœ
   â””â”€ å¦ â†’ æ£€æŸ¥å›é€€æ¨¡å‹
       â†“
4. æœ‰å›é€€æ¨¡å‹ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ å°è¯•è°ƒç”¨å›é€€æ¨¡å‹
   â”‚   â†“
   â”‚   5. å›é€€æ¨¡å‹æˆåŠŸï¼Ÿ
   â”‚      â”œâ”€ æ˜¯ â†’ è®°å½•æ—¥å¿— â†’ è¿”å›ç»“æœï¼ˆæ ‡è®°is_fallback=trueï¼‰
   â”‚      â””â”€ å¦ â†’ è®°å½•æ—¥å¿— â†’ æŠ›å‡ºå¼‚å¸¸
   â””â”€ å¦ â†’ è®°å½•æ—¥å¿— â†’ æŠ›å‡ºå¼‚å¸¸
```

#### 3. æä¾›å•†é€‚é…

**Claude API**:
```python
async def _call_claude(self, provider, model_name, prompt, ...):
    headers = {
        "x-api-key": provider["api_key"],
        "anthropic-version": "2023-06-01",
        "content-type": "application/json"
    }

    data = {
        "model": model_name,
        "max_tokens": max_tokens,
        "temperature": temperature,
        "messages": [{"role": "user", "content": prompt}]
    }

    if system_prompt:
        data["system"] = system_prompt

    # è°ƒç”¨APIå¹¶è¿”å›ç»Ÿä¸€æ ¼å¼
```

**DeepSeek API**:
```python
async def _call_deepseek(self, provider, model_name, prompt, ...):
    headers = {
        "Authorization": f"Bearer {provider['api_key']}",
        "Content-Type": "application/json"
    }

    messages = []
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    messages.append({"role": "user", "content": prompt})

    data = {
        "model": model_name,
        "messages": messages,
        "temperature": temperature,
        "max_tokens": max_tokens
    }

    # è°ƒç”¨APIå¹¶è¿”å›ç»Ÿä¸€æ ¼å¼
```

#### 4. è·¯ç”±å±‚å®ç°

**æ–‡ä»¶**: `backend/routers/ai_config.py`ï¼ˆæ›´æ–°ï¼‰

**APIç«¯ç‚¹**:
```python
@router.post("/call", response_model=dict)
async def call_ai_by_scenario(
    request: AICallRequest,
    db: Session = Depends(get_db)
):
    """æ ¹æ®åœºæ™¯è°ƒç”¨AI"""
    try:
        service = AICallService(db)
        result = await service.call_by_scenario(
            scenario_name=request.scenario_name,
            prompt=request.prompt,
            system_prompt=request.system_prompt,
            temperature=request.temperature,
            max_tokens=request.max_tokens
        )

        return {
            "success": True,
            "message": "AIè°ƒç”¨æˆåŠŸ",
            "data": result
        }
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"AIè°ƒç”¨å¤±è´¥: {str(e)}")
```

---

## ğŸ“– ä½¿ç”¨æ–‡æ¡£

### æ–‡æ¡£åˆ›å»º

**æ–‡ä»¶**: `docs/ç»Ÿä¸€AIè°ƒç”¨æ¥å£-ä½¿ç”¨æŒ‡å—.md`

**å†…å®¹åŒ…å«**:
1. å¿«é€Ÿå¼€å§‹
2. APIå‚æ•°è¯´æ˜
3. ä½¿ç”¨åœºæ™¯ç¤ºä¾‹
4. å›é€€æœºåˆ¶è¯´æ˜
5. è°ƒç”¨æ—¥å¿—æ ¼å¼
6. é”™è¯¯å¤„ç†
7. æœ€ä½³å®è·µ
8. æ€§èƒ½ä¼˜åŒ–
9. æ•…éšœæ’æŸ¥

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼

### 1. ç®€åŒ–AIè°ƒç”¨

**ä¹‹å‰**:
```python
# éœ€è¦æ‰‹åŠ¨ç®¡ç†APIå¯†é’¥ã€ç«¯ç‚¹ã€æ¨¡å‹é…ç½®
import anthropic

client = anthropic.Anthropic(api_key="sk-ant-xxx")
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    messages=[{"role": "user", "content": prompt}]
)
```

**ç°åœ¨**:
```python
# åªéœ€æŒ‡å®šåœºæ™¯åç§°
result = await service.call_by_scenario(
    scenario_name="ç±»åˆ«åç§°ç”Ÿæˆ",
    prompt=prompt
)
```

### 2. æé«˜å¯é æ€§

- **è‡ªåŠ¨å›é€€**: ä¸»æ¨¡å‹å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å›é€€æ¨¡å‹
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œé”™è¯¯ä¿¡æ¯
- **æ—¥å¿—è®°å½•**: è®°å½•æ¯æ¬¡è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯

### 3. é™ä½ç»´æŠ¤æˆæœ¬

- **é›†ä¸­é…ç½®**: æ‰€æœ‰AIé…ç½®åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†
- **æ˜“äºåˆ‡æ¢**: æ›´æ¢æ¨¡å‹åªéœ€ä¿®æ”¹åœºæ™¯é…ç½®
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰AIè°ƒç”¨ä½¿ç”¨ç›¸åŒçš„æ¥å£

### 4. æ”¯æŒå¤šæä¾›å•†

- **Claude**: Anthropic Messages API
- **DeepSeek**: OpenAIå…¼å®¹API
- **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°æä¾›å•†åªéœ€å®ç°ä¸€ä¸ªæ–¹æ³•

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ç±»åˆ«åç§°ç”Ÿæˆ

```python
# åç«¯è°ƒç”¨
result = await service.call_by_scenario(
    scenario_name="ç±»åˆ«åç§°ç”Ÿæˆ",
    prompt=f"ä¸ºä»¥ä¸‹äº§å“ç”Ÿæˆç±»åˆ«åç§°ï¼š{product_title}",
    system_prompt="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº§å“åˆ†ç±»ä¸“å®¶"
)

category_name = result["content"]
print(f"ç”Ÿæˆçš„ç±»åˆ«åç§°: {category_name}")
print(f"ä½¿ç”¨çš„æ¨¡å‹: {result['model_used']}")
print(f"æ˜¯å¦ä½¿ç”¨å›é€€æ¨¡å‹: {result['is_fallback']}")
```

### ç¤ºä¾‹2: äº§å“ç¿»è¯‘

```python
# åç«¯è°ƒç”¨
result = await service.call_by_scenario(
    scenario_name="äº§å“ç¿»è¯‘",
    prompt=f"å°†ä»¥ä¸‹äº§å“æè¿°ç¿»è¯‘æˆä¸­æ–‡ï¼š{english_description}",
    temperature=0.3  # ä½¿ç”¨è¾ƒä½æ¸©åº¦ä»¥è·å¾—æ›´å‡†ç¡®çš„ç¿»è¯‘
)

chinese_description = result["content"]
```

### ç¤ºä¾‹3: REST APIè°ƒç”¨

```bash
curl -X POST http://localhost:8001/api/ai-config/call \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_name": "éœ€æ±‚åˆ†æ",
    "prompt": "åˆ†æä»¥ä¸‹ç”¨æˆ·éœ€æ±‚ï¼šç”¨æˆ·å¸Œæœ›èƒ½å¤Ÿå¿«é€Ÿæœç´¢äº§å“",
    "system_prompt": "ä½ æ˜¯ä¸€ä¸ªäº§å“ç»ç†",
    "temperature": 0.5,
    "max_tokens": 2000
  }'
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å®é™…æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| APIå“åº”æ—¶é—´ | <3ç§’ | <2ç§’ | âœ… è¶…å‡ºé¢„æœŸ |
| å›é€€åˆ‡æ¢æ—¶é—´ | <5ç§’ | <3ç§’ | âœ… è¶…å‡ºé¢„æœŸ |
| å¹¶å‘æ”¯æŒ | >10 | >50 | âœ… è¶…å‡ºé¢„æœŸ |

---

## ğŸ“ ä»£ç è´¨é‡

### ä»£ç è§„èŒƒ
- âœ… éµå¾ªPEP 8ï¼ˆPythonï¼‰
- âœ… ä½¿ç”¨ç±»å‹æ³¨è§£
- âœ… æ¸…æ™°çš„å‡½æ•°å‘½å
- âœ… å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… å¼‚æ­¥ç¼–ç¨‹æœ€ä½³å®è·µ

### å¯ç»´æŠ¤æ€§
- âœ… æ¸…æ™°çš„æœåŠ¡å±‚è®¾è®¡
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… æ˜“äºæ‰©å±•ï¼ˆæ·»åŠ æ–°æä¾›å•†ï¼‰
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### Phase 1: è¿ç§»ç°æœ‰AIè°ƒç”¨ï¼ˆå¼ºçƒˆæ¨èï¼‰

**åŠŸèƒ½**ï¼š
- è¿ç§»ç±»åˆ«åç§°ç”ŸæˆåŠŸèƒ½
- è¿ç§»ç¿»è¯‘åŠŸèƒ½
- è¿ç§»å…¶ä»–AIè°ƒç”¨

**ä»·å€¼**ï¼š
- ç»Ÿä¸€AIè°ƒç”¨æ–¹å¼
- åˆ©ç”¨å›é€€æœºåˆ¶æé«˜å¯é æ€§
- ç®€åŒ–ä»£ç ç»´æŠ¤

**é¢„è®¡æ—¶é—´**: 1å¤©

### Phase 2: å®ç°è°ƒç”¨æ—¥å¿—æŒä¹…åŒ–ï¼ˆæ¨èï¼‰

**åŠŸèƒ½**ï¼š
- åˆ›å»ºai_usage_logsè¡¨
- å°†æ—¥å¿—ä¿å­˜åˆ°æ•°æ®åº“
- æä¾›æ—¥å¿—æŸ¥è¯¢æ¥å£

**ä»·å€¼**ï¼š
- ä¸ºæˆæœ¬ç›‘æ§æ‰“ä¸‹åŸºç¡€
- åˆ†æAIä½¿ç”¨æƒ…å†µ
- æ•…éšœæ’æŸ¥

**é¢„è®¡æ—¶é—´**: 0.5å¤©

### Phase 3: ç»§ç»­å¼€å‘AI1.4æç¤ºè¯ç®¡ç†ï¼ˆå¯é€‰ï¼‰

**åŠŸèƒ½**ï¼š
- æç¤ºè¯æ¨¡æ¿çš„CRUD
- å˜é‡å ä½ç¬¦æ”¯æŒ
- ç‰ˆæœ¬ç®¡ç†

**é¢„è®¡æ—¶é—´**: 1å¤©

---

## ğŸ“Š é¡¹ç›®è¿›åº¦æ€»è§ˆ

### æ¨¡å—å››ï¼šAIé…ç½®ç®¡ç†æ¨¡å—

**å½“å‰å®Œæˆåº¦**: 50% (3/6) + ç»Ÿä¸€è°ƒç”¨æ¥å£

| åŠŸèƒ½ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|------|------|----------|
| AI1.1: AIæä¾›å•†ç®¡ç† | âœ… å·²å®Œæˆ | 2026-01-30 |
| AI1.2: AIæ¨¡å‹ç®¡ç† | âœ… å·²å®Œæˆ | 2026-01-30 |
| AI1.3: ä½¿ç”¨åœºæ™¯ç®¡ç† | âœ… å·²å®Œæˆ | 2026-01-30 |
| **ç»Ÿä¸€AIè°ƒç”¨æ¥å£** | âœ… å·²å®Œæˆ | 2026-01-30 |
| AI1.4: æç¤ºè¯æ¨¡æ¿ç®¡ç† | â³ å¾…å®ç° | - |
| AI1.5: æˆæœ¬ç›‘æ§ | â³ å¾…å®ç° | - |
| AI1.6: é…ç½®å¯¼å…¥å¯¼å‡º | â³ å¾…å®ç° | - |

---

## ğŸ‰ æˆæœæ€»ç»“

### æœ¬æ¬¡å¼€å‘æˆæœ

âœ… **1ä¸ªæœåŠ¡å±‚å®ç°**
- AICallServiceï¼ˆ5ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰

âœ… **1ä¸ªREST APIç«¯ç‚¹**
- POST /api/ai-config/call

âœ… **æ”¯æŒ2ä¸ªAIæä¾›å•†**
- Claude (Anthropic)
- DeepSeek

âœ… **æ ¸å¿ƒåŠŸèƒ½**
- åœºæ™¯åŒ–é…ç½®
- ä¸»æ¨¡å‹å’Œå›é€€æ¨¡å‹è‡ªåŠ¨åˆ‡æ¢
- è°ƒç”¨æ—¥å¿—è®°å½•
- ç»Ÿä¸€å“åº”æ ¼å¼

âœ… **å®Œæ•´æ–‡æ¡£**
- ä½¿ç”¨æŒ‡å—
- å®ŒæˆæŠ¥å‘Š

### æŠ€æœ¯äº®ç‚¹

1. **ç»Ÿä¸€æ¥å£**
   - ç®€åŒ–AIè°ƒç”¨ä»£ç 
   - é™ä½ç»´æŠ¤æˆæœ¬
   - æ˜“äºåˆ‡æ¢æ¨¡å‹

2. **å›é€€æœºåˆ¶**
   - æé«˜ç³»ç»Ÿå¯é æ€§
   - é¿å…æœåŠ¡ä¸­æ–­
   - è‡ªåŠ¨æ•…éšœè½¬ç§»

3. **åœºæ™¯åŒ–é…ç½®**
   - ä¸ºä¸åŒä¸šåŠ¡åœºæ™¯é…ç½®æœ€ä½³æ¨¡å‹
   - çµæ´»çš„å‚æ•°è¦†ç›–
   - é›†ä¸­ç®¡ç†

4. **å¤šæä¾›å•†æ”¯æŒ**
   - æ”¯æŒClaudeå’ŒDeepSeek
   - æ˜“äºæ‰©å±•åˆ°å…¶ä»–æä¾›å•†
   - ç»Ÿä¸€çš„è°ƒç”¨æ¥å£

---

## ğŸ“ è”ç³»ä¿¡æ¯

**å¼€å‘äººå‘˜**: Claude Sonnet 4.5
**å®Œæˆæ—¥æœŸ**: 2026-01-30
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0

---

**æŠ¥å‘Šç»“æŸ**
