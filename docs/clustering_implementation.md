# 聚类与需求分析实现方案

**文档版本**: v1.0
**创建日期**: 2026-01-27
**最后更新**: 2026-01-27

---

## 目录

1. [数据结构确认](#数据结构确认)
2. [语义聚类实现](#语义聚类实现)
3. [需求分析实现](#需求分析实现)
4. [交付产品识别实现](#交付产品识别实现)
5. [性能优化策略](#性能优化策略)

---

## 数据结构确认

### Etsy 数据格式

**文件格式**: Excel (.xlsx) 或 CSV (.csv)
**表头**: 无表头（第一行即为数据）
**列数**: 固定 5 列

**列结构**:

| 列索引 | 字段名 | 数据类型 | 必需 | 说明 | 示例 |
|--------|--------|----------|------|------|------|
| 0 | product_name | string | 是 | 商品名称/描述 | Wire Art Template Whole Shop Bundle... |
| 1 | rating | float | 否 | 评分 (0-5) | 4.7 |
| 2 | review_count | string | 否 | 评价数量（带括号和单位） | (1.1k), (19.1k), (15) |
| 3 | shop_name | string | 否 | 店铺名称 | CraftedKnit |
| 4 | price | float | 否 | 价格 | 38.35 |

### 数据预处理规则

**评价数量转换** (review_count):

输入: (1.1k) -> 输出: 1100
输入: (19.1k) -> 输出: 19100
输入: (15) -> 输出: 15
输入: (2.5m) -> 输出: 2500000

---

## 语义聚类实现

### REQ-003: 语义聚类分析

#### 1. 聚类输入

**输入字段**: 仅使用 product_name (列 0)

**原因**:
- 商品名称包含了核心语义信息
- 描述字段在 Etsy 数据中即为商品名称
- 简化处理，提高效率

#### 2. 向量化

**模型**: Sentence Transformers - all-MiniLM-L6-v2

**特点**:
- 轻量级模型（约 80MB）
- 快速推理速度
- 良好的语义表示能力
- 支持批量处理

**性能指标**:
- 10,000 条商品: 约 30-60 秒
- 100,000 条商品: 约 5-10 分钟

#### 3. 聚类算法

**算法**: HDBSCAN (Hierarchical Density-Based Spatial Clustering)

**参数配置**:

| 参数 | 默认值 | 可调范围 | 说明 |
|------|--------|----------|------|
| min_cluster_size | 15 | 5-50 | 最小簇大小 |
| min_samples | 5 | 2-10 | 最小样本数 |
| metric | euclidean | - | 距离度量 |
| cluster_selection_method | eom | eom, leaf | 簇选择方法 |

**重要说明**:
- **无簇数量限制**: 不设置上限或下限，让算法自动发现所有可能的簇
- **穷尽式分组**: 尽可能将所有商品分配到簇中
- **噪音点处理**: 噪音点（cluster_id = -1）保留，供人工决策

#### 4. 参数调优

**用户可调参数**:
- min_cluster_size: 控制簇的最小大小
  - 增大 -> 簇变少、簇变大
  - 减小 -> 簇变多、簇变小
- min_samples: 控制簇的密度要求
  - 增大 -> 更严格，噪音点增多
  - 减小 -> 更宽松，噪音点减少

---

## 需求分析实现

### REQ-004: 需求分析（AI 辅助）

#### 1. 分析粒度

**完整详细版本** - 包含以下维度:

| 维度 | 字段名 | 说明 | 示例 |
|------|--------|------|------|
| 核心需求 | core_demand | 用户的核心需求是什么 | 项目管理和任务跟踪 |
| 使用场景 | use_cases | 在什么场景下使用 | 团队协作、个人待办、项目规划 |
| 目标用户 | target_users | 谁会使用这类产品 | 项目经理、团队领导、自由职业者 |
| 痛点 | pain_points | 解决了什么痛点 | 任务混乱、进度不透明、协作困难 |

#### 2. DeepSeek API 集成

**API 配置**:
- 使用 OpenAI 兼容接口
- 基础 URL: https://api.deepseek.com
- 模型: deepseek-chat

**Prompt 设计**:
- 输入: 簇内商品列表（前 50 个）
- 输出: JSON 格式的需求分析结果
- 包含: core_demand, use_cases, target_users, pain_points

#### 3. 批量处理

**批量分析策略**:
- 支持断点续传
- 自动保存中间结果
- API 调用失败重试 3 次
- 延迟 1 秒避免限流

**性能指标**:
- 单个簇分析: 5-10 秒
- 100 个簇: 约 10-15 分钟
- 支持断点续传，避免重复分析

---

## 交付产品识别实现

### REQ-005: 交付产品识别（AI 辅助）

#### 1. 混合识别策略

**方案**: 关键词匹配（80%） + AI 识别（20%）

**原因**:
- 关键词匹配快速、成本低
- AI 识别处理复杂情况
- 混合方案平衡准确率和效率

#### 2. 关键词匹配

**关键词库**:
- Excel: excel, spreadsheet, xls, xlsx, template
- Notion: notion, notion template
- Canva: canva, canva template
- PDF: pdf, printable, digital download
- PPT: powerpoint, ppt, pptx, presentation

**匹配逻辑**:
1. 将商品名称转为小写
2. 遍历关键词库
3. 匹配成功返回类型、格式、平台
4. 匹配失败调用 AI

#### 3. AI 识别（补充）

**使用场景**: 关键词匹配失败时

**输出字段**:
- delivery_type: 交付产品类型
- delivery_format: 具体格式
- delivery_platform: 交付平台（可选）

---

## 性能优化策略

### 1. 向量缓存

**策略**: 缓存向量化结果，避免重复计算
- 使用 MD5 哈希作为缓存键
- 保存为 .npy 文件
- 自动检测缓存是否存在

### 2. 批量处理

**策略**: 批量调用 API，减少网络开销
- 批量大小: 10-50
- 延迟控制: 1 秒
- 进度显示: 每 100 条

### 3. 数据库索引

**策略**: 为常用查询字段添加索引
- cluster_id 索引
- shop_name 索引
- import_time 索引
- 全文搜索索引

### 4. 分页查询

**策略**: 使用分页避免一次加载大量数据
- 每页 50 条
- 按导入时间倒序
- 软删除过滤

### 5. 异步处理

**策略**: 使用异步任务处理耗时操作
- 使用 Celery + Redis
- 后台执行聚类
- 前端轮询状态

---

## 总结

### 核心实现要点

1. **聚类输入**: 仅使用商品名称（列 0）
2. **聚类参数**: 用户可调，无簇数量限制，穷尽式分组
3. **需求分析**: 完整详细版本（需求+场景+用户+痛点）
4. **交付识别**: 混合策略（关键词 80% + AI 20%）
5. **批量处理**: 支持大规模数据，断点续传

### 性能指标

| 操作 | 数据量 | 预期时间 |
|------|--------|----------|
| 向量化 | 10,000 条 | 30-60 秒 |
| 聚类 | 10,000 条 | 1-2 分钟 |
| 需求分析 | 100 个簇 | 10-15 分钟 |
| 交付识别 | 10,000 条 | 5-10 分钟 |

### 下一步

1. 实现数据导入功能（REQ-001）
2. 实现语义聚类功能（REQ-003）
3. 实现需求分析功能（REQ-004）
4. 实现交付产品识别功能（REQ-005）

---

*文档创建者: Claude Sonnet 4.5*
*最后更新: 2026-01-27*
