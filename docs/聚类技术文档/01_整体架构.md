# 01 - 整体架构

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        FastAPI 后端                          │
├─────────────────────────────────────────────────────────────┤
│  POST /clustering/execute                                    │
│    ↓                                                         │
│  ClusteringService (backend/services/clustering_service.py)  │
│    ├─ load_model()           # 加载Sentence Transformers    │
│    ├─ preprocess_text()      # 文本预处理                   │
│    ├─ vectorize_products()   # 向量化 + 缓存                │
│    ├─ perform_three_stage_clustering()  # 三阶段聚类        │
│    ├─ cluster_all_products() # 主入口                       │
│    └─ generate_cluster_summary()  # 生成簇汇总              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据处理层                              │
├─────────────────────────────────────────────────────────────┤
│  1. 文本预处理                                               │
│     - 转小写                                                 │
│     - 去除特殊字符                                           │
│     - 去除尺寸信息                                           │
│     - 去除停用词                                             │
│                                                              │
│  2. 向量化                                                   │
│     - Sentence Transformers (all-mpnet-base-v2)             │
│     - 768维语义向量                                          │
│     - MD5哈希缓存                                            │
│                                                              │
│  3. 聚类                                                     │
│     - HDBSCAN算法                                            │
│     - 三阶段聚类                                             │
│     - 自动确定簇数量                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│  SQLite Database (products.db)                               │
│    ├─ products 表                                            │
│    │   ├─ product_id (主键)                                  │
│    │   ├─ product_name (商品名称)                            │
│    │   ├─ cluster_id (簇ID, -1表示噪音)                     │
│    │   └─ cluster_type (primary/secondary/micro)            │
│    │                                                          │
│    └─ cluster_summaries 表                                   │
│        ├─ cluster_id (簇ID)                                  │
│        ├─ cluster_label (簇标签)                             │
│        ├─ cluster_size (簇大小)                              │
│        ├─ priority (优先级: high/medium/low)                │
│        └─ is_direction (是否为方向簇)                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 技术栈

### 核心库

| 库名 | 版本 | 用途 |
|------|------|------|
| sentence-transformers | 2.2.2+ | 文本向量化 |
| hdbscan | 0.8.33+ | 密度聚类算法 |
| numpy | 1.24+ | 数值计算 |
| scikit-learn | 1.3+ | 机器学习工具 |
| sqlalchemy | 2.0.23 | ORM数据库操作 |
| fastapi | 0.104.1 | Web框架 |

### 模型

- **Sentence Transformers**: all-mpnet-base-v2
  - 参数量: 109M
  - 向量维度: 768
  - 训练数据: 10亿+句对
  - 适用场景: 短文本语义理解

---

## 数据流

```
输入: 15,792个商品
  ↓
[文本预处理]
  - 清洗商品名称
  - 去除噪音信息
  ↓
[向量化]
  - 转换为768维向量
  - 使用缓存加速
  ↓
[三阶段聚类]
  - 第一阶段: 生成主要簇
  - 第二阶段: 处理噪音点
  - 第三阶段: 再次处理噪音
  ↓
[数据库更新]
  - 更新products.cluster_id
  - 更新products.cluster_type
  ↓
[簇汇总生成]
  - 生成cluster_summaries记录
  - 自动生成簇标签
  - 分配优先级
  ↓
输出: 1,412个簇 + 4,620个噪音点
```

---

## 文件结构

```
backend/
├── services/
│   └── clustering_service.py    # 聚类服务核心实现
│       ├── ClusteringService类
│       ├── load_model()         # 加载模型
│       ├── preprocess_text()    # 文本预处理
│       ├── vectorize_products() # 向量化
│       ├── perform_clustering() # HDBSCAN聚类
│       ├── perform_three_stage_clustering()  # 三阶段
│       ├── cluster_all_products()  # 主入口
│       └── generate_cluster_summary()  # 生成汇总

app/
├── routers/
│   └── clustering.py            # FastAPI路由
│       └── POST /clustering/execute  # 聚类执行端点
│
└── templates/
    └── clustering.html          # 前端页面
        ├── 开始聚类按钮
        └── 聚类配置模态框

data/
├── cache/
│   └── embeddings/              # 向量缓存目录
│       └── *.pkl                # 缓存文件
│
└── products.db                  # SQLite数据库
    ├── products表
    └── cluster_summaries表
```

---

## 执行流程

### 1. 用户触发

```javascript
// 前端: clustering.html
用户点击"开始聚类"按钮
  ↓
显示配置模态框
  ↓
用户选择参数:
  - 聚类模式: 三阶段/单阶段
  - stage1_min_size: 10
  - stage2_min_size: 5
  - stage3_min_size: 3
  ↓
提交表单 (fetch POST /clustering/execute)
```

### 2. 后端处理

```python
# 后端: app/routers/clustering.py
@router.post("/execute")
async def execute_clustering(...):
    # 1. 创建聚类服务
    service = ClusteringService(db, model_name="all-mpnet-base-v2")

    # 2. 执行聚类
    result = service.cluster_all_products(
        use_three_stage=True,
        stage1_min_size=10,
        stage2_min_size=5,
        stage3_min_size=3
    )

    # 3. 生成簇汇总
    summary = service.generate_cluster_summary()

    # 4. 保存到数据库
    db.query(ClusterSummary).delete()  # 清空旧数据
    for item in summary:
        db.add(ClusterSummary(...))
    db.commit()

    # 5. 返回结果
    return {
        "success": True,
        "message": f"聚类完成！生成了 {result['n_clusters']} 个簇",
        "data": {...}
    }
```

### 3. 结果展示

```javascript
// 前端: clustering.html
接收到响应
  ↓
显示结果统计:
  - 总商品数: 15,792
  - 生成簇数: 1,412
  - 噪音点数: 4,620
  - 噪音比例: 29.26%
  ↓
提供"刷新页面"按钮
  ↓
用户刷新后查看聚类结果
```

---

## 性能特点

| 指标 | 数值 | 说明 |
|------|------|------|
| 首次执行时间 | 2-3分钟 | 包含向量化 |
| 后续执行时间 | 1-2分钟 | 使用向量缓存 |
| 内存占用 | ~550MB | 包含模型加载 |
| CPU使用 | 100% | 多核并行 |
| 缓存命中率 | ~100% | 相同商品名称 |

---

**下一篇**: 02_文本预处理.md
